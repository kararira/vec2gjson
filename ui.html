<style>
  body {
    font-family: sans-serif;
    text-align: center;
    padding: 16px;
  }
  button {
    background-color: #0d99ff;
    color: white;
    border: none;
    padding: 10px 20px;
    border-radius: 4px;
    font-size: 14px;
    cursor: pointer;
  }
  button:disabled {
    background-color: #e0e0e0;
    cursor: not-allowed;
  }
  p {
    font-size: 12px;
    color: #555;
  }
</style>

<h2>GeoJSON エクスポート</h2>
<p id="message">データを待っています...</p>
<button id="export-all-button" disabled>1. 全フロアのGeoJSONを保存</button>
<button id="generate-walkable-button" disabled>2. 全フロアの歩行可能エリアを生成</button><p id="message"></p>
<script src="https://cdn.jsdelivr.net/npm/@turf/turf@7/turf.min.js"></script>

<script>
  const exportAllButton = document.getElementById('export-all-button');
  const generateButton = document.getElementById('generate-walkable-button');
  const messageEl = document.getElementById('message');
  
  let allFloorsData = null; // フロアごとのデータリストを保持
  let filenamePrefix = 'map';

  function downloadJson(jsonData, fileName) {
    const blob = new Blob([jsonData], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const link = document.createElement('a');
    link.href = url; link.download = fileName;
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    URL.revokeObjectURL(url);
    return new Promise(resolve => setTimeout(resolve, 100));
  }

  function fixWindingOrder(geoJsonData) {
    const correctedFeatures = geoJsonData.features.map((feature) => {
      return turf.rewind(feature, { inplace: false });
    });
    return { type: 'FeatureCollection', features: correctedFeatures };
  }

  // code.tsからメッセージを受け取る
  window.onmessage = (event) => {
    const msg = event.data.pluginMessage;
    
    if (msg.type === 'export-geojson-all-floors') {
      allFloorsData = JSON.parse(msg.data); // [{ frameId: "...", geoJson: {...} }, ...]
      filenamePrefix = msg.filenamePrefix;
      
      exportAllButton.disabled = false;
      generateButton.disabled = false;
      exportAllButton.textContent = `1. 全フロアのGeoJSONを保存 (${allFloorsData.length}件)`;
      messageEl.textContent = "データ受信完了。各操作を選択してください。";
    } 
    else if (msg.type === 'error') {
      messageEl.textContent = msg.message;
    }
  };

  // 全フロアのGeoJSONをそれぞれダウンロード
  exportAllButton.onclick = async () => {
    if (!allFloorsData) return;
    for (const floorData of allFloorsData) {
      const correctedGeoJson = fixWindingOrder(floorData.geoJson);
      const fileName = `${floorData.frameId}.geojson`;
      // const fileName = `${filenamePrefix}-${floorData.frameId}.geojson`;
      await downloadJson(JSON.stringify(correctedGeoJson, null, 2), fileName);
    }
    messageEl.textContent = "全フロアのGeoJSONを保存しました。";
  };
  
  // 全フロアの歩行可能エリアをそれぞれ生成・ダウンロード
  generateButton.onclick = async () => {
    if (!allFloorsData) return;

    messageEl.textContent = "全フロアの歩行可能エリアを計算中...";
    generateButton.disabled = true;

    try {
      // 各フロアデータでループ処理
      for (const floorData of allFloorsData) {
        const floorId = floorData.frameId;
        const floorGeoJson = floorData.geoJson;
        messageEl.textContent = `${floorId} のエリアを計算中...`;

        const baseFeatures = floorGeoJson.features.filter(f => f.properties.id === 'base');
        const stairFeatures = floorGeoJson.features.filter(f => f.properties.id.includes('stairs')); // 'stairs'を含むかで判定
        const obstacleFeatures = floorGeoJson.features.filter(f => f.properties.id !== 'base' && !f.properties.id.includes('stairs') &&  !f.properties.id.includes('elevator'));

        if (baseFeatures.length === 0) {
          console.warn(`フロア "${floorId}" に "base" オブジェクトが見つかりません。`);
          continue;
        }
        
        let walkableArea = baseFeatures[0];

        obstacleFeatures.forEach(obstacle => {
          const result = turf.difference(walkableArea, obstacle);
          if (result) walkableArea = result;
        });
        
        // stairFeatures.forEach(stair => {
        //   walkableArea = turf.union(walkableArea, stair);
        // });
        
        // 元のプロパティを維持しつつ、新しい名前を付ける
        // walkableArea.properties = {
        //     ...walkableArea.properties,
        //     name: `${floorId}-walkable-area`,
        // };

        const finalGeoJson = {
          type: "FeatureCollection",
          features: [walkableArea]
        };

        const newFileName = `walkable-area-${floorId}.geojson`;
        await downloadJson(JSON.stringify(finalGeoJson, null, 2), newFileName);
      }
      messageEl.textContent = "すべてのフロアの処理が完了しました。";
    } catch (error) {
      console.error("歩行可能エリアの生成中にエラー:", error);
      messageEl.textContent = `エラー: ${error.message}`;
    } finally {
      generateButton.disabled = false;
    }
  };
</script>