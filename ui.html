<style>
  body {
    font-family: sans-serif;
    text-align: center;
    padding: 16px;
  }
  button {
    background-color: #0d99ff;
    color: white;
    border: none;
    padding: 10px 20px;
    border-radius: 4px;
    font-size: 14px;
    cursor: pointer;
  }
  button:disabled {
    background-color: #e0e0e0;
    cursor: not-allowed;
  }
  p {
    font-size: 12px;
    color: #555;
  }
</style>

<h2>GeoJSON エクスポート</h2>
<button id="export-button" disabled>データを処理中...</button>
<p id="message"></p>
<script src="https://cdn.jsdelivr.net/npm/@turf/turf@7/turf.min.js"></script>

<script>
  const exportButton = document.getElementById('export-button');
  const messageEl = document.getElementById('message');
  let geoJsonData = null;
  let fileName = 'map.geojson';

  //これいる？巻き順が決まっているらしいけどなんかなくてもうまくいく
  function fixWindingOrder(geoJsonData) {
    const correctedFeatures = geoJsonData.features.map((feature) => {
      // turf.rewindは、geojsonの仕様通りに巻き順を自動修正してくれる
      // { inplace: false } で元のデータを変更しないようにする
      return turf.rewind(feature, { inplace: false });
    });
    
    console.log("winding rode");
    return {
      type: 'FeatureCollection',
      features: correctedFeatures,
    };
  }

  // code.tsからメッセージを受け取る
  window.onmessage = (event) => {
    const msg = event.data.pluginMessage;
    
    if (msg.type === 'export-geojson') {
      geoJsonData = JSON.stringify(fixWindingOrder(JSON.parse(msg.data)), null, 2);
      // geoJsonData = msg.data;
      fileName = msg.filename;
      exportButton.disabled = false;
      exportButton.textContent = 'GeoJSONを保存';
      messageEl.textContent = `${msg.data.split('"Feature"').length - 1}件のデータを準備しました。`;
    } 
    else if (msg.type === 'error') {
      messageEl.textContent = msg.message;
      // 3秒後にプラグインを閉じる
      setTimeout(() => {
        parent.postMessage({ pluginMessage: { type: 'close' } }, '*');
      }, 3000);
    }
  };

  // ボタンクリックでダウンロード処理を実行
  exportButton.onclick = () => {
    if (!geoJsonData) return;

    // 1. Blobオブジェクトを作成
    const blob = new Blob([geoJsonData], { type: 'application/json' });
    
    // 2. ダウンロード用のURLを生成
    const url = URL.createObjectURL(blob);
    
    // 3. 非表示の<a>タグを作成してクリックさせる
    const link = document.createElement('a');
    link.href = url;
    link.download = fileName; // ダウンロードファイル名を設定
    
    document.body.appendChild(link);
    link.click(); // プログラム的にクリックしてダウンロードを開始
    document.body.removeChild(link);
    
    URL.revokeObjectURL(url); // メモリを解放
  };
</script>